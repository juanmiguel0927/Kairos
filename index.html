<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kair√≥s 360 - Gesti√≥n Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f1f5f9;
            color: #0f172a;
        }

        .glass-header { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .active-mission-highlight {
            border: 3px solid #6366f1 !important;
            background: linear-gradient(110deg, #f5f7ff 0%, #ffffff 100%) !important;
            transform: scale(1.02);
            box-shadow: 0 15px 25px -5px rgba(99, 102, 241, 0.3) !important;
            z-index: 10;
            position: relative;
        }

        .active-mission-highlight::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 2.2rem;
            border: 2px solid #6366f1;
            opacity: 0.5;
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.05); opacity: 0; } }

        .calendar-day {
            min-width: 60px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .calendar-day.selected {
            background-color: white;
            color: #0f172a;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(-4px);
        }

        .modal-overlay { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); }
        .step-card { background: #ffffff; color: #0f172a; }
        .tab-btn-active { background-color: #4f46e5 !important; color: white !important; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); }

        .config-block {
            background: #ffffff;
            border-radius: 1.5rem;
            padding: 1.25rem;
            border: 1px solid #e2e8f0;
            margin-bottom: 1rem;
        }

        .input-label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 6px; display: block; }
        .styled-input { width: 100%; background: #f8fafc; border-radius: 0.75rem; padding: 0.75rem; font-size: 14px; font-weight: 700; border: 2px solid #f1f5f9; outline: none; }

        .live-tag { background: #6366f1; color: white; padding: 2px 8px; border-radius: 6px; font-size: 8px; font-weight: 800; display: flex; align-items: center; gap: 4px; }
        .live-dot { width: 6px; height: 6px; background: white; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body class="pb-24">

    <!-- MODAL TUTORIAL / REGISTRO INICIAL -->
    <div id="tutorial-modal" class="fixed inset-0 z-[500] modal-overlay hidden flex items-center justify-center p-6 text-slate-900">
        <div class="bg-white max-w-sm w-full rounded-[3rem] p-10 shadow-2xl text-center">
            
            <div id="t-step-0" class="t-step">
                <div class="w-20 h-20 bg-indigo-100 text-indigo-600 rounded-[2rem] mx-auto mb-8 flex items-center justify-center">
                    <i class="fas fa-user-edit text-3xl"></i>
                </div>
                <h2 class="text-2xl font-black mb-4 uppercase">¬øQui√©n eres?</h2>
                <p class="text-slate-500 text-sm mb-6 leading-relaxed">Para comenzar tu nueva organizaci√≥n, ingresa tu nombre aqu√≠:</p>
                <input type="text" id="name-input-init" class="styled-input text-center text-xl mb-8 border-indigo-100 font-black text-indigo-600" placeholder="Nombre...">
                <button onclick="saveNameTutorial()" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-black uppercase text-xs shadow-xl">Siguiente</button>
            </div>

            <div id="t-step-1" class="t-step hidden">
                <div class="w-20 h-20 bg-green-100 text-green-600 rounded-[2rem] mx-auto mb-8 flex items-center justify-center">
                    <i class="fas fa-check-circle text-3xl"></i>
                </div>
                <h2 class="text-2xl font-black mb-4">HOLA, <span class="user-name-display text-indigo-600"></span>!</h2>
                <p class="text-slate-600 text-lg font-semibold leading-relaxed mb-10 text-center">Toca tus tareas al terminarlas. La app resaltar√° lo que debes hacer ahora.</p>
                <button onclick="nextTStep(2)" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-black uppercase text-xs shadow-xl">Siguiente</button>
            </div>

            <div id="t-step-2" class="t-step hidden">
                <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-[2rem] mx-auto mb-8 flex items-center justify-center">
                    <i class="fas fa-sliders-h text-3xl"></i>
                </div>
                <h2 class="text-2xl font-black mb-4">PERSONALIZA</h2>
                <p class="text-slate-600 text-lg font-semibold leading-relaxed mb-10 text-center">Configura <b>trabajo, deporte, medicinas, ocio</b> y m√°s en el panel superior.</p>
                <button onclick="closeTutorial()" class="w-full bg-indigo-950 text-white py-5 rounded-[2rem] font-black uppercase text-xs shadow-xl">¬°A Ganar!</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass-header text-white p-7 rounded-b-[4rem] shadow-2xl sticky top-0 z-50">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter uppercase leading-tight">KAIR√ìS <span class="text-indigo-400">360</span></h1>
                <p class="text-[9px] font-bold text-indigo-300 uppercase tracking-[0.15em] mt-1 opacity-90">Domina tu momento, equilibra tu mundo</p>
            </div>
            <div class="flex gap-2">
                <button onclick="openTutorial()" class="bg-white/10 p-3 rounded-2xl border border-white/5 shadow-sm"><i class="fas fa-question text-sm"></i></button>
                <button onclick="openConfig()" class="bg-white/10 p-3 rounded-2xl border border-white/5 shadow-sm"><i class="fas fa-sliders-h text-sm"></i></button>
                <button onclick="openTech()" class="bg-indigo-600 p-3 rounded-2xl shadow-lg border border-indigo-400/30"><i class="fas fa-brain text-sm"></i></button>
            </div>
        </div>

        <div class="flex justify-between items-end">
            <div class="flex items-center gap-4">
                <span id="live-clock" class="text-4xl font-black tracking-tighter">00:00</span>
                <div class="bg-indigo-500/20 px-3 py-1 rounded-xl border border-indigo-400/30">
                    <span class="text-[10px] font-black uppercase text-indigo-200 tracking-widest"><span class="user-name-display"></span></span>
                </div>
            </div>
            <p id="live-date" class="text-[10px] font-extrabold opacity-60 uppercase tracking-widest text-right"></p>
        </div>

        <div id="calendar-strip" class="flex overflow-x-auto gap-4 no-scrollbar mt-8 pb-2 px-1"></div>
    </header>

    <main class="p-6 space-y-8 max-w-xl mx-auto">
        <section class="bg-white rounded-[3rem] p-8 shadow-sm border border-slate-100">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-sm font-black text-slate-800 uppercase flex items-center gap-2"><i class="fas fa-chart-line text-indigo-500"></i> Mi Esfuerzo</h2>
                <div id="total-perc" class="text-[10px] font-black text-indigo-600 bg-indigo-50 px-4 py-1.5 rounded-full">0% LOGRADO</div>
            </div>
            <div class="grid grid-cols-2 gap-5" id="stats-grid"></div>
        </section>

        <section class="space-y-4">
            <div class="flex justify-between items-center px-4">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Cronograma</h3>
                <button onclick="toggleVacation()" id="vacation-btn" class="px-5 py-2.5 bg-slate-200 text-slate-600 text-[9px] font-black rounded-full uppercase flex items-center gap-2 border border-slate-300 transition-all">
                    <i class="fas fa-umbrella-beach"></i> Modo Vacaciones
                </button>
            </div>
            <div id="task-list" class="space-y-4"></div>
        </section>

        <section class="bg-slate-900 text-white p-8 rounded-[3.5rem] shadow-xl border border-white/5">
            <h4 class="text-xs font-black uppercase tracking-widest mb-6 flex items-center gap-3"><i class="fas fa-heartbeat text-red-500"></i> Mi Salud Visual</h4>
            <div id="medical-info" class="space-y-4"></div>
        </section>

        <footer class="text-center py-10 opacity-50">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">Desarrollado para</p>
            <p class="text-xs font-black text-slate-900 uppercase tracking-widest">Juan Miguel Rios Redondo</p>
        </footer>
    </main>

    <!-- Panel de Control -->
    <div id="config-modal" class="fixed inset-0 z-[400] modal-overlay hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full max-w-lg rounded-t-[3.5rem] sm:rounded-[3.5rem] shadow-2xl flex flex-col max-h-[92vh] overflow-hidden">
            <div class="p-8 pb-4">
                <div class="flex justify-between items-center mb-6 text-slate-900">
                    <h3 class="text-2xl font-black italic tracking-tighter uppercase">Configurar</h3>
                    <button onclick="closeConfig()"><i class="fas fa-times-circle text-slate-300 text-3xl"></i></button>
                </div>
                <div class="flex gap-1 bg-slate-100 p-1.5 rounded-2xl border border-slate-200 overflow-x-auto no-scrollbar">
                    <button onclick="setTab('perfil')" id="tab-perfil" class="flex-1 py-3 text-[10px] font-black rounded-xl px-3 whitespace-nowrap">Perfil</button>
                    <button onclick="setTab('editor')" id="tab-editor" class="flex-1 py-3 text-[10px] font-black rounded-xl px-3 whitespace-nowrap">Horarios</button>
                    <button onclick="setTab('medicina')" id="tab-medicina" class="flex-1 py-3 text-[10px] font-black rounded-xl px-3 whitespace-nowrap">M√©dico</button>
                    <button onclick="setTab('data')" id="tab-data" class="flex-1 py-3 text-[10px] font-black rounded-xl px-3 whitespace-nowrap">Datos</button>
                </div>
            </div>
            <div id="modal-content" class="flex-1 overflow-y-auto px-8 pb-8 no-scrollbar text-slate-900"></div>
            <div class="p-8 border-t border-slate-50"><button onclick="saveChanges()" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-black uppercase text-xs shadow-xl active:scale-95 transition-all">Guardar Todo</button></div>
        </div>
    </div>

    <!-- Estrategias -->
    <div id="tech-modal" class="fixed inset-0 z-[450] modal-overlay hidden flex items-center justify-center p-6 text-slate-900">
        <div class="bg-white w-full max-w-2xl rounded-[3.5rem] p-10 shadow-2xl max-h-[85vh] overflow-y-auto no-scrollbar">
            <h3 class="text-2xl font-black italic text-indigo-900 mb-10 text-center uppercase tracking-tighter border-b-2 border-indigo-50 pb-6">Estrategias Pro</h3>
            <div class="space-y-10" id="tech-content"></div>
            <button onclick="closeTech()" class="w-full mt-10 py-6 bg-indigo-600 text-white rounded-[2rem] font-black uppercase text-xs shadow-xl">Regresar</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- DATA ---
        let state = {
            userName: '', selectedDate: new Intl.DateTimeFormat('sv-SE').format(new Date()),
            isVacation: false, history: {}, tab: 'perfil',
            config: {
                userName: '', treatmentStart: '2026-01-30', vacationHidden: ['academia'],
                template: { entreno: [], estudio: [], finde: [] }, treatments: []
            }
        };

        const configFB = JSON.parse(__firebase_config);
        firebase.initializeApp(configFB);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'kairos-final-v30';

        async function init() {
            auth.onAuthStateChanged(async (u) => {
                if (u) {
                    state.user = u;
                    const snap = await db.doc(`artifacts/${appId}/users/${u.uid}/config/master`).get();
                    if(snap.exists()) {
                        state.config = snap.data();
                        updateNameDisplays();
                        render();
                    } else {
                        openTutorial(true);
                    }
                    db.collection(`artifacts/${appId}/users/${u.uid}/history`).onSnapshot(s => {
                        s.forEach(doc => state.history[doc.id] = doc.data());
                        render();
                    });
                } else { auth.signInAnonymously(); }
            });
            initCalendar(); renderTech(); updateLive(); setInterval(updateLive, 30000);
        }

        // --- RENDER ---
        function render() {
            const list = document.getElementById('task-list');
            const medical = document.getElementById('medical-info');
            const now = new Date();
            const todayISO = new Intl.DateTimeFormat('sv-SE').format(now);
            const dObj = new Date(state.selectedDate + 'T12:00:00');
            const dayName = new Intl.DateTimeFormat('es-ES', { weekday: 'long' }).format(dObj).toLowerCase();
            
            const getT = (f) => {
                const tr = state.config.treatments.find(x => x.name.toLowerCase().includes(f.toLowerCase()));
                if (!tr) return { active: false };
                const s = new Date(tr.start + 'T00:00:00');
                const sel = new Date(state.selectedDate + 'T00:00:00');
                const d = Math.floor((sel - s) / 86400000) + 1;
                const l = tr.unit === 'dias' ? parseInt(tr.duration) : parseInt(tr.duration) * 30;
                return { active: d >= 1 && d <= l, day: d, limit: l, freq: tr.doseFreq };
            };

            const fS = getT('Fluoro'); const oS = getT('Olopa');
            let routine = dayName.includes('s√°b') || dayName.includes('dom') ? [...state.config.template.finde] : 
                          (['lunes', 'mi√©rcoles', 'viernes'].includes(dayName) ? [...state.config.template.entreno] : [...state.config.template.estudio]);

            if (state.isVacation) routine = routine.filter(t => !state.config.vacationHidden.includes(t.type));
            
            list.innerHTML = '';
            let dc = 0; const s = { musica: 0, deporte: 0, academia: 0, salud: 0, total: { musica: 0, deporte: 0, academia: 0, salud: 0 } };

            routine.forEach(t => {
                if (t.type === 'salud') {
                    if (t.task.toLowerCase().includes('fluoro') && !fS.active) return;
                    if (t.task.toLowerCase().includes('olopa') && !oS.active) return;
                }
                const st = parseTime(t.start, state.selectedDate);
                const en = parseTime(t.end, state.selectedDate);
                const isNow = state.selectedDate === todayISO && now >= st && now <= new Date(en.getTime() + 59000);
                const isD = (state.history[state.selectedDate] || {})[t.id];
                const dur = (en - st) / 60000;
                if(s.total[t.type] !== undefined) { s.total[t.type] += dur; if(isD) { s[t.type] += dur; dc++; } }

                const col = { salud: 'bg-red-500', musica: 'bg-purple-500', deporte: 'bg-orange-500', academia: 'bg-indigo-500', ocio: 'bg-emerald-500' };
                list.innerHTML += `<div onclick="toggleTask('${t.id}')" class="flex items-stretch bg-white rounded-[2.5rem] shadow-sm border-2 transition-all ${isD ? 'opacity-40 grayscale' : isNow ? 'active-mission-highlight' : 'border-white'}">
                    <div class="w-2 ${col[t.type]} rounded-l-[2.5rem]"></div>
                    <div class="flex-1 p-6 flex items-center gap-6">
                        <div class="min-w-[85px] text-center border-r border-slate-50 pr-4">
                            <p class="text-[11px] font-black text-slate-800 leading-none">${t.start}</p>
                            <p class="text-[9px] font-bold text-slate-300 mt-2 uppercase">${t.end}</p>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="text-sm font-black uppercase text-slate-800 tracking-tight">${t.task}</h3>
                                ${isNow ? '<div class="live-tag"><div class="live-dot"></div>VIVO</div>' : ''}
                            </div>
                            <span class="text-[7px] font-black uppercase bg-slate-50 border px-2 py-0.5 rounded-full ${col[t.type].replace('bg-','text-')}">${t.type}</span>
                        </div>
                        <i class="fas ${isD ? 'fa-check-circle text-green-500' : 'fa-circle text-slate-100'} text-3xl"></i>
                    </div>
                </div>`;
            });
            medical.innerHTML = state.config.treatments.map(tr => {
                const info = getT(tr.name);
                return `<div class="p-4 bg-white/5 rounded-3xl border border-white/5 flex justify-between items-center">
                    <div><p class="font-black ${info.active ? 'text-red-400' : 'text-slate-500'} uppercase text-[11px]">${tr.name}</p><p class="opacity-60 text-[10px] uppercase font-bold tracking-widest">${tr.doseFreq}</p></div>
                    <span class="text-[10px] font-black bg-white/10 px-3 py-1 rounded-lg">${info.active ? 'D√≠a '+info.day+'/'+info.limit : 'FIN'}</span>
                </div>`;
            }).join('') || '<p class="text-center text-slate-400 text-xs py-4 uppercase font-black">Sin tratamientos activos</p>';
            renderStats(s, dc, routine.length);
        }

        // --- ACTIONS ---
        window.saveNameTutorial = () => {
            const n = document.getElementById('name-input-init').value;
            if(!n) return;
            state.config.userName = n;
            updateNameDisplays();
            nextTStep(1);
        };
        window.nextTStep = (s) => {
            document.querySelectorAll('.t-step').forEach(el => el.classList.add('hidden'));
            document.getElementById(`t-step-${s}`).classList.remove('hidden');
        };
        window.openTutorial = (isFirst = false) => {
            document.getElementById('tutorial-modal').classList.remove('hidden');
            nextTStep(isFirst ? 0 : 1);
        };
        window.closeTutorial = () => {
            document.getElementById('tutorial-modal').classList.add('hidden');
            saveChanges();
        };

        window.openConfig = () => { document.getElementById('config-modal').classList.remove('hidden'); setTab('perfil'); };
        window.closeConfig = () => document.getElementById('config-modal').classList.add('hidden');
        window.openTech = () => document.getElementById('tech-modal').classList.remove('hidden');
        window.closeTech = () => document.getElementById('tech-modal').classList.add('hidden');
        
        window.setTab = (t) => {
            state.tab = t;
            ['perfil','editor','medicina','data'].forEach(x => {
                const el = document.getElementById(`tab-${x}`);
                el.className = `flex-1 py-3 text-[10px] font-black rounded-xl uppercase px-4 whitespace-nowrap ${t === x ? 'tab-btn-active' : 'text-slate-500'}`;
            });
            renderTab();
        };

        function renderTab() {
            const c = document.getElementById('modal-content'); c.innerHTML = '';
            if(state.tab === 'perfil') {
                c.innerHTML = `<div class="p-8 bg-slate-50 rounded-[2.5rem] space-y-4">
                    <label class="input-label">Tu Nombre</label>
                    <input type="text" value="${state.config.userName}" onchange="state.config.userName=this.value; updateNameDisplays();" class="styled-input text-xl border-indigo-100">
                    <p class="text-[10px] text-slate-400 font-bold italic text-center">Aparecer√° en el encabezado.</p>
                </div>`;
            } else if(state.tab === 'editor') {
                c.innerHTML = `<p class="text-center text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Modifica tu rutina horaria:</p>`;
                ['entreno','estudio','finde'].forEach(day => {
                    c.innerHTML += `<div class="p-4 bg-indigo-50 rounded-2xl mb-4 font-black uppercase text-[10px] text-indigo-900">${day}</div>`;
                    (state.config.template[day] || []).forEach((t, i) => {
                        c.innerHTML += `<div class="config-block shadow-sm">
                            <label class="input-label">Actividad</label><input type="text" value="${t.task}" onchange="state.config.template['${day}'][${i}].task=this.value" class="styled-input mb-4">
                            <div class="flex gap-4"><div class="flex-1"><label class="input-label text-center">Inicia</label><input type="text" value="${t.start}" onchange="state.config.template['${day}'][${i}].start=this.value" class="styled-input text-center"></div><div class="flex-1"><label class="input-label text-center">Fin</label><input type="text" value="${t.end}" onchange="state.config.template['${day}'][${i}].end=this.value" class="styled-input text-center"></div></div>
                        </div>`;
                    });
                });
            } else if(state.tab === 'medicina') {
                state.config.treatments.forEach((tr, i) => {
                    c.innerHTML += `<div class="config-block space-y-4 shadow-sm">
                        <div><label class="input-label">Medicina</label><input type="text" value="${tr.name}" onchange="state.config.treatments[${i}].name=this.value" class="styled-input"></div>
                        <div class="flex gap-3"><div class="flex-1"><label class="input-label">Inicia</label><input type="date" value="${tr.start}" onchange="state.config.treatments[${i}].start=this.value" class="styled-input"></div><div class="flex-1"><label class="input-label">Cantidad</label><div class="flex gap-1"><input type="number" value="${tr.duration}" onchange="state.config.treatments[${i}].duration=this.value" class="w-12 styled-input p-2 text-center"><select onchange="state.config.treatments[${i}].unit=this.value" class="styled-input p-1 text-[9px] uppercase"><option value="dias" ${tr.unit==='dias'?'selected':''}>D√≠as</option><option value="meses" ${tr.unit==='meses'?'selected':''}>Meses</option></select></div></div></div>
                        <div><label class="input-label">Pauta</label><input type="text" value="${tr.doseFreq}" onchange="state.config.treatments[${i}].doseFreq=this.value" class="styled-input"></div>
                    </div>`;
                });
            } else if(state.tab === 'data') {
                c.innerHTML = `<div class="p-8 bg-indigo-50 rounded-[3rem] space-y-6 text-center shadow-inner">
                    <button onclick="exportJSON()" class="w-full bg-white text-indigo-600 p-5 rounded-2xl font-black text-[10px] uppercase shadow-md flex items-center justify-center gap-3 border border-indigo-100"><i class="fas fa-file-download"></i> Exportar archivo .JSON</button>
                    <div class="pt-4 space-y-4">
                        <p class="text-[10px] font-black text-indigo-400 uppercase opacity-60">Restaurar versi√≥n anterior:</p>
                        <input type="file" id="json-input" class="hidden" accept=".json" onchange="importJSON(event)">
                        <button onclick="document.getElementById('json-input').click()" class="w-full bg-slate-950 text-white p-5 rounded-2xl font-black text-[10px] uppercase shadow-xl flex items-center justify-center gap-3"><i class="fas fa-file-upload"></i> Cargar archivo .JSON</button>
                    </div>
                    <div class="pt-8 border-t border-indigo-100">
                        <button onclick="resetApp()" class="w-full bg-red-100 text-red-600 p-5 rounded-2xl font-black text-[10px] uppercase border border-red-200 active:bg-red-600 active:text-white transition-all">Borrar todo y Reiniciar</button>
                    </div>
                </div>`;
            }
        }

        window.resetApp = async () => {
            if(!confirm("¬øEst√°s seguro de que quieres borrar toda la informaci√≥n y empezar de cero?")) return;
            state.config = { userName: '', treatmentStart: '2026-01-30', vacationHidden: ['academia'], template: { entreno: [], estudio: [], finde: [] }, treatments: [] };
            state.history = {};
            await saveChanges();
            location.reload();
        };

        window.saveChanges = async () => {
            if(state.user) await db.doc(`artifacts/${appId}/users/${state.user.uid}/config/master`).set(state.config);
            closeConfig(); render();
        };

        window.exportJSON = () => {
            const blob = new Blob([JSON.stringify(state.config, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `kairos360_${state.config.userName || 'user'}.json`;
            a.click();
        };

        window.importJSON = (e) => {
            const r = new FileReader();
            r.onload = (ev) => {
                try {
                    state.config = JSON.parse(ev.target.result);
                    updateNameDisplays();
                    alert("¬°Configuraci√≥n cargada con √©xito!");
                    renderTab();
                } catch(e) { alert("Archivo inv√°lido."); }
            };
            r.readAsText(e.target.files[0]);
        };

        window.toggleTask = async (id) => {
            const h = state.history[state.selectedDate] || {}; h[id] = !h[id];
            if(state.user) await db.doc(`artifacts/${appId}/users/${state.user.uid}/history/${state.selectedDate}`).set(h);
            render();
        };

        window.updateNameDisplays = () => {
            const name = state.config.userName || 'Usuario';
            document.querySelectorAll('.user-name-display').forEach(el => el.innerText = name.toUpperCase());
        };

        window.updateLive = () => {
            const n = new Date();
            document.getElementById('live-clock').innerText = n.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: true });
            document.getElementById('live-date').innerText = n.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
            render();
        }

        window.parseTime = (t, iso) => {
            const [time, mod] = t.split(' '); let [h, m] = time.split(':').map(Number);
            if(mod === 'PM' && h < 12) h += 12; if(mod === 'AM' && h === 12) h = 0;
            const d = new Date(iso + 'T00:00:00'); d.setHours(h, m, 0, 0); return d;
        }

        window.renderStats = (s, count, total) => {
            const grid = document.getElementById('stats-grid'); grid.innerHTML = '';
            [{id:'musica',l:'M√∫sica',c:'bg-purple-500'},{id:'deporte',l:'Deporte',c:'bg-orange-500'},{id:'academia',l:'Estudios',c:'bg-indigo-500'},{id:'salud',l:'Salud',c:'bg-red-500'}].forEach(type => {
                const p = s.total[type.id] > 0 ? Math.round((s[type.id] / s.total[type.id]) * 100) : 0;
                grid.innerHTML += `<div class="bg-slate-50 p-4 rounded-3xl border border-slate-100"><div class="flex justify-between mb-2"><span class="text-[9px] font-black uppercase text-slate-400">${type.l}</span><span class="text-[10px] font-black text-indigo-600">${p}%</span></div><div class="h-1.5 bg-slate-200 rounded-full overflow-hidden"><div class="${type.c} h-full transition-all duration-1000" style="width: ${p}%"></div></div></div>`;
            });
            document.getElementById('total-perc').innerText = `${Math.round((count/total)*100 || 0)}%`;
        }

        function initCalendar() {
            const strip = document.getElementById('calendar-strip'); strip.innerHTML = '';
            for (let i = -7; i <= 7; i++) {
                const d = new Date(); d.setDate(d.getDate() + i); const iso = new Intl.DateTimeFormat('sv-SE').format(d);
                const isS = iso === state.selectedDate; const day = document.createElement('div');
                day.className = `calendar-day ${isS ? 'selected' : 'text-white opacity-40 hover:opacity-100'}`;
                day.onclick = () => { state.selectedDate = iso; initCalendar(); render(); };
                day.innerHTML = `<span class="text-[8px] font-black uppercase tracking-tighter">${new Intl.DateTimeFormat('es-ES', { weekday: 'short' }).format(d)}</span><span class="text-xl font-black mt-1 leading-none">${d.getDate()}</span>`;
                strip.appendChild(day); if (isS) day.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            }
        }

        function renderTech() {
            const t = [
                { i: 'üçÖ', n: 'Pomodoro (25/5)', p: 'Usa 25 min para tareas. Al sonar, descansa 5 min sin pantallas. Mantiene tu mente fresca para la m√∫sica.' },
                { i: 'üëÅÔ∏è', n: 'Regla 20-20-20', p: 'Cada 20 min en Duolingo y apps: mira algo a 6 metros por 20 segundos. Fundamental para sanar tus ojos.' },
                { i: 'üéª', n: 'Recuerdo Activo', p: 'En tu instrumento, toca de memoria antes de leer la partitura. Crear√°s conexiones 10 veces m√°s r√°pidas.' },
                { i: 'üß©', n: 'Pr√°ctica Intercalada', p: 'Alterna: 15 min idiomas, 15 min ritmo, 15 min teor√≠a. Estimula tu cerebro al m√°ximo.' },
                { i: 'üéì', n: 'M√©todo Feynman', p: 'Al terminar tus deberes, explica a tus padres lo que aprendiste hoy como si tuvieran 5 a√±os. ¬°Dominio total!' }
            ];
            document.getElementById('tech-content').innerHTML = t.map(x => `
                <div class="flex gap-6 items-start">
                    <span class="text-4xl leading-none">${x.i}</span>
                    <div>
                        <h4 class="text-lg font-black text-indigo-900 uppercase mb-2">${x.n}</h4>
                        <p class="text-base text-slate-500 leading-relaxed font-semibold">${x.p}</p>
                    </div>
                </div>`).join('');
        }

        window.onload = init;
    </script>
</body>
</html>

