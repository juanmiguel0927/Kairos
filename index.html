<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kair√≥s 360 - Dashboard Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        :root {
            --bg-main: #FFFFFF;
            --bg-card: #F8FAFC;
            --text-main: #000000;
            --text-muted: #475569;
            --border: #CBD5E1;
            --accent: #4F46E5;
        }

        .dark {
            --bg-main: #020617;
            --bg-card: #0F172A;
            --text-main: #FFFFFF;
            --text-muted: #94A3B8;
            --border: #1E293B;
            --accent: #6366F1;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .glass-header { background: linear-gradient(135deg, #020617 0%, #1e1b4b 100%); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .active-mission-card {
            border: 3px solid var(--accent) !important;
            background: var(--bg-main) !important;
            transform: scale(1.02);
            box-shadow: 0 20px 40px -10px rgba(99, 102, 241, 0.4) !important;
            z-index: 20;
        }

        .calendar-day {
            min-width: 65px;
            height: 85px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .calendar-day.selected {
            background-color: #FFFFFF;
            color: #000000 !important;
            font-weight: 800;
        }

        .modal-overlay { background: rgba(0, 0, 0, 0.98); backdrop-filter: blur(12px); }
        .tab-btn-active { background-color: var(--accent) !important; color: #FFFFFF !important; }
        
        .health-bar-container { height: 12px; background: rgba(128,128,128,0.2); border-radius: 20px; overflow: hidden; margin-top: 10px; }
        .health-bar-fill { height: 100%; background: #EF4444; transition: width 1s ease; box-shadow: 0 0 15px rgba(239, 68, 68, 0.6); }

        .time-label-box {
            min-width: 95px;
            border-right: 2px solid var(--border);
            margin-right: 15px;
            text-align: center;
            line-height: 1.2;
            color: var(--text-main);
        }

        .styled-input { 
            width: 100%; 
            background: var(--bg-main); 
            border: 2px solid var(--border); 
            border-radius: 0.8rem; 
            padding: 1rem; 
            color: var(--text-main); 
            font-weight: 800; 
            outline: none; 
        }

        .modal-content-area label { color: #475569 !important; font-weight: 800; display: block; margin-bottom: 4px; }
        .modal-content-area input, .modal-content-area select { color: #000000 !important; background: #FFFFFF !important; border: 1px solid #CBD5E1 !important; margin-bottom: 12px; }

        .live-tag { background: #EF4444; color: white; padding: 2px 8px; border-radius: 6px; font-size: 8px; font-weight: 900; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        footer p { color: var(--text-muted); font-weight: 600; }
        footer strong { color: var(--text-main); font-weight: 800; }
    </style>
</head>
<body class="pb-24 dark">

    <!-- MODAL TUTORIAL / REGISTRO NOMBRE -->
    <div id="tutorial-modal" class="fixed inset-0 z-[3000] modal-overlay hidden flex items-center justify-center p-6 text-slate-900">
        <div class="bg-white max-w-md w-full rounded-[3.5rem] p-10 text-center shadow-2xl">
            
            <div id="t-step-0" class="t-step block">
                <div class="w-20 h-20 bg-indigo-100 text-indigo-600 rounded-[2.5rem] mx-auto mb-6 flex items-center justify-center"><i class="fas fa-id-badge text-3xl"></i></div>
                <h2 class="text-2xl font-black mb-4 uppercase">BIENVENIDO</h2>
                <p class="text-slate-500 text-sm mb-6 font-bold">Ingresa tu nombre y presiona <b>Enter</b> para activar el sistema:</p>
                <input type="text" id="name-input-init" class="styled-input text-center text-xl mb-8 border-indigo-100 font-black text-indigo-600 !bg-slate-50" placeholder="Nombre..." onkeydown="if(event.key==='Enter') handleInitialSave()">
                <button onclick="handleInitialSave()" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-black uppercase text-xs shadow-xl active:scale-95 transition-all">Siguiente</button>
            </div>

            <div id="t-step-1" class="t-step hidden text-left">
                <h3 class="text-indigo-600 text-[10px] font-black uppercase mb-2">Gu√≠a 1/4</h3>
                <h2 class="text-xl font-black mb-4 uppercase text-slate-800">CRONOGRAMA</h2>
                <p class="text-slate-600 text-sm font-bold mb-6 leading-relaxed">Toca cualquier misi√≥n cuando la termines. Si hay huecos entre tareas, el sistema crear√° un bloque de <b>Descanso</b> autom√°tico.</p>
                <button onclick="nextTStep(2)" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-black uppercase text-xs shadow-xl">Siguiente (Enter)</button>
            </div>

            <div id="t-step-2" class="t-step hidden text-left">
                <h3 class="text-indigo-600 text-[10px] font-black uppercase mb-2">Gu√≠a 2/4</h3>
                <h2 class="text-xl font-black mb-4 uppercase text-slate-800">SALUD VISUAL</h2>
                <p class="text-slate-600 text-sm font-bold mb-6 leading-relaxed">El sistema rastrea tus gotas. Te dir√° qu√© d√≠a del tratamiento llevas y cu√°ntos faltan para que tus ojos sanen.</p>
                <button onclick="nextTStep(3)" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-black uppercase text-xs shadow-xl">Siguiente (Enter)</button>
            </div>

            <div id="t-step-3" class="t-step hidden text-left">
                <h3 class="text-indigo-600 text-[10px] font-black uppercase mb-2">Gu√≠a 3/4</h3>
                <h2 class="text-xl font-black mb-4 uppercase text-slate-800">AJUSTES</h2>
                <p class="text-slate-600 text-sm font-bold mb-6 leading-relaxed">Usa el men√∫ de hamburguesa para a√±adir nuevas misiones, configurar tus medicinas o restaurar copias de seguridad.</p>
                <button onclick="nextTStep(4)" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-black uppercase text-xs shadow-xl">Siguiente (Enter)</button>
            </div>

            <div id="t-step-4" class="t-step hidden text-center">
                <div class="w-20 h-20 bg-green-100 text-green-600 rounded-[2.5rem] mx-auto mb-6 flex items-center justify-center"><i class="fas fa-rocket text-3xl"></i></div>
                <h2 class="text-2xl font-black mb-4 uppercase text-slate-800">¬°HOLA, <span class="user-name-display text-indigo-600"></span>!</h2>
                <p class="text-slate-600 font-bold mb-10 text-sm italic">Presiona <b>Enter</b> para dominar tu d√≠a.</p>
                <button onclick="finalizeTutorial()" class="w-full bg-slate-950 text-white py-5 rounded-[2rem] font-black uppercase text-xs shadow-xl">¬°Comenzar!</button>
            </div>
        </div>
    </div>

    <!-- UI HEADER -->
    <header class="glass-header text-white p-6 rounded-b-[3.5rem] shadow-2xl sticky top-0 z-50">
        <div class="flex justify-between items-start mb-6">
            <div class="flex items-center gap-4">
                <button onclick="openConfig()" class="bg-white/10 w-11 h-11 rounded-2xl flex items-center justify-center border border-white/5 active:scale-90 transition-all shadow-sm">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <div>
                    <h1 class="text-xl font-black italic tracking-tighter uppercase leading-tight">KAIR√ìS <span class="text-indigo-400">360</span></h1>
                    <p class="text-[8px] font-black text-indigo-300 uppercase tracking-widest leading-none mt-1">Domina tu momento, equilibra tu mundo</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleTheme()" class="bg-white/10 p-4 rounded-2xl border border-white/5 active:scale-90 shadow-inner"><i id="theme-icon" class="fas fa-sun text-sm"></i></button>
                <button onclick="openTutorial(false)" class="bg-white/10 p-4 rounded-2xl border border-white/5 active:scale-90 shadow-inner"><i class="fas fa-question text-sm"></i></button>
                <button onclick="openTech()" class="bg-indigo-600 p-4 rounded-2xl shadow-lg border border-indigo-400/30 active:scale-90"><i class="fas fa-brain text-sm"></i></button>
            </div>
        </div>

        <div class="flex justify-between items-end">
            <div class="flex items-center gap-4 text-white">
                <span id="live-clock" class="text-5xl font-black tracking-tighter tabular-nums">00:00 AM</span>
                <div class="bg-indigo-500/20 px-4 py-1.5 rounded-xl border border-indigo-400/30">
                    <span class="text-[10px] font-black uppercase text-indigo-200 display-name">Usuario</span>
                </div>
            </div>
            <div class="text-right">
                <div id="streak-indicator" class="bg-orange-500/20 text-orange-400 border border-orange-500/30 px-3 py-1 rounded-full text-[9px] font-black uppercase mb-1 hidden">Racha üî•</div>
                <p id="live-date" class="text-[10px] font-extrabold opacity-70 uppercase tracking-widest text-white"></p>
            </div>
        </div>
        <div id="calendar-strip" class="flex overflow-x-auto gap-4 no-scrollbar mt-8 pb-2 px-1"></div>
    </header>

    <main class="p-6 space-y-10 max-w-xl mx-auto">
        <!-- Balance Rendimiento -->
        <section class="bg-[var(--bg-card)] rounded-[2.5rem] p-7 border border-[var(--border)] shadow-sm">
            <div class="flex justify-between items-center mb-8 text-[var(--text-main)]">
                <h2 class="text-sm font-black uppercase flex items-center gap-2 font-black"><i class="fas fa-bolt text-indigo-500"></i> Mi Rendimiento</h2>
                <div id="total-perc" class="text-[10px] font-black text-indigo-500 bg-indigo-500/10 px-4 py-1.5 rounded-full uppercase">0%</div>
            </div>
            <div class="grid grid-cols-2 gap-5" id="stats-grid"></div>
        </section>

        <!-- Cronograma -->
        <section class="space-y-5">
            <div class="flex justify-between items-center px-4">
                <h3 class="text-[11px] font-black uppercase tracking-widest italic text-[var(--text-main)]">Actividades Diarias</h3>
                <button onclick="toggleVacation()" id="vacation-btn" class="px-5 py-2.5 bg-[var(--bg-card)] text-[var(--text-muted)] text-[9px] font-black rounded-full uppercase border border-[var(--border)] shadow-sm">Vacaciones</button>
            </div>
            <div id="task-list" class="space-y-4 text-slate-900"></div>
        </section>

        <!-- Salud -->
        <section class="bg-slate-900 rounded-[3rem] p-8 border border-slate-800 shadow-2xl relative overflow-hidden text-white">
            <h4 class="text-xs font-black uppercase tracking-widest mb-8 text-white flex items-center gap-3">
                <i class="fas fa-capsules text-red-500"></i> Salud Visual
            </h4>
            <div id="medical-info" class="space-y-8"></div>
        </section>

        <footer class="text-center py-10 opacity-100 border-t border-[var(--border)] mt-16">
            <p class="text-[10px] font-black uppercase tracking-[0.3em] mb-1 italic text-indigo-500">Desarrollado por</p>
            <p class="text-sm font-black uppercase tracking-widest text-[var(--text-main)]">Juan Miguel Rios Redondo</p>
        </footer>
    </main>

    <!-- PANEL DE CONTROL -->
    <div id="config-modal" class="fixed inset-0 z-[1500] modal-overlay hidden flex items-end sm:items-center justify-center p-0 sm:p-4 text-slate-900">
        <div class="bg-white w-full max-w-lg rounded-t-[3.5rem] sm:rounded-[3rem] shadow-2xl flex flex-col h-[92vh] overflow-hidden">
            <div class="p-8 pb-4">
                <div class="flex justify-between items-center mb-6 text-slate-900">
                    <h3 class="text-2xl font-black italic uppercase tracking-tighter">AJUSTES</h3>
                    <button onclick="closeConfig()"><i class="fas fa-times-circle text-slate-300 text-3xl transition-colors hover:text-slate-600"></i></button>
                </div>
                <div class="flex gap-1 bg-slate-100 p-1.5 rounded-2xl overflow-x-auto no-scrollbar shadow-inner">
                    <button onclick="setTab('perfil')" id="tab-perfil" class="flex-1 py-3 text-[10px] font-black rounded-xl px-5 whitespace-nowrap">Perfil</button>
                    <button onclick="setTab('horarios')" id="tab-horarios" class="flex-1 py-3 text-[10px] font-black rounded-xl px-5 whitespace-nowrap">Horas</button>
                    <button onclick="setTab('medico')" id="tab-medico" class="flex-1 py-3 text-[10px] font-black rounded-xl px-5 whitespace-nowrap">Salud</button>
                    <button onclick="setTab('filtro')" id="tab-filtro" class="flex-1 py-3 text-[10px] font-black rounded-xl px-5 whitespace-nowrap">Filtro</button>
                    <button onclick="setTab('data')" id="tab-data" class="flex-1 py-3 text-[10px] font-black rounded-xl px-5 whitespace-nowrap">Datos</button>
                </div>
            </div>
            <div id="modal-content" class="flex-1 overflow-y-auto px-8 pb-8 no-scrollbar text-slate-900 modal-content-area"></div>
            <div class="p-8 border-t border-slate-50 flex gap-2">
                <button onclick="saveAndClose()" class="w-full bg-indigo-600 text-white py-6 rounded-[2rem] font-black uppercase text-xs shadow-xl active:scale-95 transition-all">Guardar Todo (Enter)</button>
            </div>
        </div>
    </div>

    <!-- ESTRATEGIAS (AMPLIADAS Y DETALLADAS) -->
    <div id="tech-modal" class="fixed inset-0 z-[2500] modal-overlay hidden flex items-center justify-center p-6 text-slate-900">
        <div class="bg-white w-full max-w-2xl rounded-[3.5rem] p-10 shadow-2xl max-h-[85vh] overflow-y-auto no-scrollbar">
            <h3 class="text-2xl font-black text-indigo-900 mb-10 uppercase tracking-tighter border-b-2 border-indigo-50 pb-6 text-center italic">Estrategias de Alto Rendimiento</h3>
            <div class="space-y-12 text-left font-medium text-slate-700" id="tech-content"></div>
            <button onclick="closeTech()" class="w-full mt-12 py-6 bg-indigo-600 text-white rounded-[2rem] font-black uppercase text-xs shadow-xl active:scale-95 transition-all">Entendido (Enter)</button>
        </div>
    </div>

    <script>
        // --- DATA E HORARIOS MAESTROS ---
        const MASTER_CONFIG = {
            userName: '', treatmentStart: '2026-01-30', theme: 'dark',
            vacationHidden: ['academia'],
            template: {
                entreno: [
                    { id: 'h1', start: '06:15 AM', end: '06:30 AM', task: 'Fluorometolona (Gota 1)', type: 'salud' },
                    { id: 'h2', start: '07:00 AM', end: '08:00 AM', task: 'Instrumento Principal', type: 'musica' },
                    { id: 'h3', start: '08:30 AM', end: '08:45 AM', task: 'Olopatadina (Dosis 1)', type: 'salud' },
                    { id: 'h4', start: '08:45 AM', end: '11:00 AM', task: 'Entrenamiento', type: 'deporte' },
                    { id: 'h5', start: '11:15 AM', end: '12:15 PM', task: 'Tareas Colegio', type: 'academia' },
                    { id: 'h6', start: '12:15 PM', end: '12:30 PM', task: 'Fluorometolona (Pre-Col)', type: 'salud' },
                    { id: 'h7', start: '12:30 PM', end: '06:00 PM', task: 'Colegio', type: 'academia' },
                    { id: 'h8', start: '08:30 PM', end: '08:45 PM', task: 'Olopatadina (Dosis 2)', type: 'salud' },
                    { id: 'm1', start: '08:45 PM', end: '09:05 PM', task: 'Bloque Arm√≥nico', type: 'musica' },
                    { id: 'm2', start: '09:05 PM', end: '09:25 PM', task: 'Lectura a 1ra Vista', type: 'musica' },
                    { id: 'm3', start: '09:25 PM', end: '09:45 PM', task: 'Formar O√≠do', type: 'musica' },
                    { id: 'id1', start: '09:45 PM', end: '10:00 PM', task: 'Duolingo', type: 'ocio' },
                    { id: 'h10', start: '10:00 PM', end: '10:15 PM', task: 'Fluorometolona (Dosis 3)', type: 'salud' }
                ],
                estudio: [
                    { id: 's1', start: '06:15 AM', end: '06:30 AM', task: 'Fluorometolona (Gota 1)', type: 'salud' },
                    { id: 's2', start: '07:00 AM', end: '08:15 AM', task: 'Tareas Colegio', type: 'academia' },
                    { id: 's3', start: '08:30 AM', end: '08:45 AM', task: 'Olopatadina (Dosis 1)', type: 'salud' },
                    { id: 'm1', start: '08:45 AM', end: '09:15 AM', task: 'Bloque Arm√≥nico', type: 'musica' },
                    { id: 'm2', start: '09:15 AM', end: '09:45 AM', task: 'Lectura a 1ra Vista', type: 'musica' },
                    { id: 'm3', start: '09:45 AM', end: '10:15 AM', task: 'Formar O√≠do', type: 'musica' },
                    { id: 'id1', start: '10:15 AM', end: '10:45 AM', task: 'Duolingo', type: 'ocio' },
                    { id: 'h6', start: '12:15 PM', end: '12:30 PM', task: 'Fluorometolona (Pre-Col)', type: 'salud' },
                    { id: 'h7', start: '12:30 PM', end: '06:00 PM', task: 'Colegio', type: 'academia' },
                    { id: 'h8', start: '08:30 PM', end: '08:45 PM', task: 'Olopatadina (Dosis 2)', type: 'salud' },
                    { id: 'h10', start: '10:00 PM', end: '10:15 PM', task: 'Fluorometolona (Dosis 3)', type: 'salud' }
                ],
                finde: [
                    { id: 'f1', start: '08:30 AM', end: '08:45 AM', task: 'Olopatadina 1', type: 'salud' },
                    { id: 'm1', start: '09:30 AM', end: '10:30 AM', task: 'Bloque Arm√≥nico', type: 'musica' },
                    { id: 'm2', start: '10:30 AM', end: '11:30 AM', task: 'Lectura a 1ra Vista', type: 'musica' },
                    { id: 'id1', start: '11:30 AM', end: '12:00 PM', task: 'Duolingo', type: 'ocio' },
                    { id: 'f5', start: '08:30 PM', end: '08:45 PM', task: 'Olopatadina 2', type: 'salud' }
                ]
            },
            treatments: [
                { id: 'tr1', name: 'Fluorometolona 0.1%', start: '2026-01-30', duration: 10, unit: 'dias', doseFreq: '8' },
                { id: 'tr2', name: 'Olopatadina 0.2%', start: '2026-01-30', duration: 2, unit: 'meses', doseFreq: '12' }
            ]
        };

        let state = {
            selectedDate: new Intl.DateTimeFormat('sv-SE').format(new Date()),
            isVacation: false, history: {}, tab: 'perfil', dayType: 'estudio',
            config: JSON.parse(JSON.stringify(MASTER_CONFIG))
        };

        // --- SISTEMA ---
        function saveLocal() { 
            localStorage.setItem('kairos_vfinal_v95', JSON.stringify(state.config)); 
            localStorage.setItem('kairos_hist_v95', JSON.stringify(state.history));
        }

        function loadLocal() {
            const c = localStorage.getItem('kairos_vfinal_v95');
            const h = localStorage.getItem('kairos_hist_v95');
            if(c) state.config = JSON.parse(c); else openTutorial(true);
            if(h) state.history = JSON.parse(h);
            if(!state.config.userName) openTutorial(true);
            applyTheme(); updateNameDisplays();
        }

        window.onkeydown = (e) => {
            if(e.key === 'Escape') { closeConfig(); closeTech(); }
            if(e.key === 'Enter') {
                if(!document.getElementById('tutorial-modal').classList.contains('hidden')) {
                    if(!document.getElementById('t-step-0').classList.contains('hidden')) handleInitialSave();
                    else if(document.getElementById('t-step-4').classList.contains('hidden')) nextTStep(null, true);
                    else finalizeTutorial();
                } else if(!document.getElementById('tech-modal').classList.contains('hidden')) {
                    closeTech();
                } else if(!document.getElementById('config-modal').classList.contains('hidden')) {
                    saveAndClose();
                }
            }
        };

        function toggleTheme() { state.config.theme = state.config.theme === 'dark' ? 'light' : 'dark'; applyTheme(); saveLocal(); }
        function applyTheme() {
            const b = document.body;
            if(state.config.theme === 'dark') b.classList.add('dark');
            else b.classList.remove('dark');
            document.getElementById('theme-icon').className = state.config.theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        function init() { loadLocal(); initCalendar(); renderTech(); updateLive(); }

        function injectGaps(routine) {
            const sorted = [...routine].sort((a,b) => parseTime(a.start, state.selectedDate) - parseTime(b.start, state.selectedDate));
            const withGaps = [];
            for(let i=0; i<sorted.length; i++) {
                withGaps.push(sorted[i]);
                if(i < sorted.length - 1) {
                    const currentEnd = parseTime(sorted[i].end, state.selectedDate);
                    const nextStart = parseTime(sorted[i+1].start, state.selectedDate);
                    if(nextStart > currentEnd) {
                        withGaps.push({ id: 'gap_'+i, start: formatTo12(currentEnd), end: formatTo12(nextStart), task: 'Tiempo Libre / Relax', type: 'ocio', isGap: true });
                    }
                }
            }
            return withGaps;
        }

        function render() {
            const list = document.getElementById('task-list');
            const med = document.getElementById('medical-info');
            const now = new Date();
            const todayISO = new Intl.DateTimeFormat('sv-SE').format(now);
            
            const checkT = (tr) => {
                const sDate = new Date(tr.start + 'T00:00:00');
                const selDate = new Date(state.selectedDate + 'T00:00:00');
                const diff = Math.floor((selDate - sDate) / 86400000) + 1;
                const lim = tr.unit === 'dias' ? parseInt(tr.duration) : parseInt(tr.duration) * 30;
                const left = lim - diff;
                return { active: diff >= 1 && diff <= lim, current: Math.max(1, diff), limit: lim, left: Math.max(0, left), perc: Math.min(100, Math.max(0, (diff/lim)*100)) };
            };

            const dayName = new Date(state.selectedDate + 'T12:00:00').toLocaleDateString('es-ES', { weekday: 'long' }).toLowerCase();
            const isF = dayName.includes('s√°b') || dayName.includes('dom');
            let routine = isF ? [...state.config.template.finde] : 
                          (['lunes', 'mi√©rcoles', 'viernes'].some(d => dayName.includes(d)) ? [...state.config.template.entreno] : [...state.config.template.estudio]);

            if (state.isVacation) routine = routine.filter(t => !state.config.vacationHidden.includes(t.type));
            
            const fullRoutine = injectGaps(routine);
            list.innerHTML = '';
            let dc = 0; const s = { musica: 0, deporte: 0, academia: 0, salud: 0, total: { musica: 0, deporte: 0, academia: 0, salud: 0 } };

            fullRoutine.forEach(t => {
                const st = parseTime(t.start, state.selectedDate);
                const en = parseTime(t.end, state.selectedDate);
                const isNow = state.selectedDate === todayISO && now >= st && now <= new Date(en.getTime() + 59000);
                const isD = (state.history[state.selectedDate] || {})[t.id];
                const dur = (en - st) / 60000;
                if(!t.isGap && s.total[t.type] !== undefined) { s.total[t.type] += dur; if(isD) { s[t.type] += dur; dc++; } }

                const col = { salud: 'bg-red-500', musica: 'bg-purple-500', deporte: 'bg-orange-500', academia: 'bg-indigo-500', ocio: 'bg-emerald-500' };
                list.innerHTML += `<div onclick="toggleTask('${t.id}')" class="flex items-stretch bg-[var(--bg-card)] rounded-[2.2rem] border border-[var(--border)] transition-all ${isD ? 'opacity-30 grayscale' : isNow ? 'active-mission-card' : ''} ${t.isGap ? 'bg-slate-100 dark:bg-slate-900/40 opacity-70 border-dashed' : ''}">
                    <div class="w-2 ${t.isGap ? 'bg-slate-500' : col[t.type]} rounded-l-[2.2rem]"></div>
                    <div class="flex-1 p-6 flex items-center text-[var(--text-main)]">
                        <div class="time-label-box">
                            <p class="text-[15px] font-black leading-none mb-1">${t.start}</p>
                            <p class="text-[10px] font-bold text-[var(--text-muted)] uppercase tracking-tighter">${t.end}</p>
                        </div>
                        <div class="flex-1 pr-2">
                            <h3 class="text-[16px] font-black uppercase tracking-tight ${t.isGap ? 'text-slate-500' : ''}">${t.task}</h3>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[8px] font-black uppercase bg-slate-500/10 px-2 py-0.5 rounded-full">${t.isGap ? 'Descanso' : t.type}</span>
                                ${isNow ? '<div class="live-tag">AHORA</div>' : ''}
                            </div>
                        </div>
                        <i class="fas ${isD ? 'fa-check-circle text-green-500' : 'fa-circle text-[var(--border)]'} text-3xl"></i>
                    </div>
                </div>`;
            });

            med.innerHTML = state.config.treatments.map(tr => {
                const info = checkT(tr);
                return `<div class="p-6 bg-slate-800/80 rounded-[2.2rem] border border-white/10 text-white shadow-xl">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="font-black ${info.active ? 'text-red-400' : 'text-slate-500'} uppercase text-[13px] leading-tight tracking-tight">${tr.name}</p>
                            <p class="opacity-40 text-[10px] font-bold mt-1 uppercase tracking-widest">Frecuencia: Cada ${tr.doseFreq}h</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[14px] font-black leading-none uppercase tracking-tighter">${info.active ? `D√≠a ${info.current}` : 'FINALIZADO'}</p>
                            <p class="text-[10px] font-black text-red-400 uppercase mt-2">${info.active ? `Faltan ${info.left} d√≠as` : ''}</p>
                        </div>
                    </div>
                    <div class="health-bar-container"><div class="health-bar-fill" style="width: ${info.perc}%"></div></div>
                </div>`;
            }).join('');
            renderStats(s, dc, routine.length);
        }

        // --- ACTIONS ---
        window.handleInitialSave = () => { const n = document.getElementById('name-input-init').value; if(!n) return; state.config.userName = n; saveLocal(); updateNameDisplays(); document.getElementById('t-step-0').classList.add('hidden'); document.getElementById('t-step-1').classList.remove('hidden'); };
        window.finalizeTutorial = () => { document.getElementById('tutorial-modal').classList.add('hidden'); render(); };
        window.nextTStep = (s, auto = false) => { if(auto) { const current = Array.from(document.querySelectorAll('.t-step')).findIndex(el => !el.classList.contains('hidden')); s = current + 1; } if(s > 4) return; document.querySelectorAll('.t-step').forEach(el => el.classList.add('hidden')); document.getElementById(`t-step-${s}`).classList.remove('hidden'); };
        window.openTutorial = (f = false) => { document.getElementById('tutorial-modal').classList.remove('hidden'); if(f) { document.getElementById('t-step-0').classList.remove('hidden'); document.getElementById('t-step-1').classList.add('hidden'); } else { nextTStep(1); } };
        window.openConfig = () => { document.getElementById('config-modal').classList.remove('hidden'); setTab('perfil'); };
        window.closeConfig = () => { document.getElementById('config-modal').classList.add('hidden'); render(); };
        window.saveAndClose = () => { saveLocal(); document.getElementById('config-modal').classList.add('hidden'); render(); };
        window.resetApp = () => { if(!confirm("¬øBorrar todo?")) return; localStorage.clear(); location.reload(); };
        window.setTab = (t) => { state.tab = t; ['perfil','horarios','medico','filtro','data'].forEach(x => { document.getElementById(`tab-${x}`).className = `flex-1 py-3 text-[10px] font-black rounded-xl uppercase px-4 whitespace-nowrap ${t === x ? 'tab-btn-active' : 'text-slate-500'}`; }); renderTab(); };

        function renderTab() {
            const c = document.getElementById('modal-content'); c.innerHTML = '';
            if(state.tab === 'perfil') {
                c.innerHTML = `<div class="p-8 bg-slate-50 rounded-[2.5rem] space-y-4 text-center text-slate-900"><label class="input-label">Tu Nombre</label><input type="text" value="${state.config.userName || ''}" onchange="state.config.userName=this.value; updateNameDisplays(); saveLocal();" class="styled-input !bg-white !text-slate-900 border-indigo-100 text-xl font-black text-center" onkeydown="if(event.key==='Enter') saveAndClose()"></div>`;
            } else if(state.tab === 'horarios') {
                c.innerHTML = `<div class="flex gap-2 mb-6 p-1 bg-slate-100 rounded-2xl text-slate-900">${['estudio','entreno','finde'].map(d => `<button onclick="state.dayType='${d}'; renderTab();" class="flex-1 py-2 text-[9px] font-black rounded-xl uppercase ${state.dayType===d?'bg-white shadow-sm text-indigo-600':'text-slate-400'}">${d}</button>`).join('')}</div>`;
                (state.config.template[state.dayType] || []).forEach((t, i) => {
                    c.innerHTML += `<div class="config-block shadow-sm !bg-slate-50 border-slate-200">
                        <button onclick="delTask('${state.dayType}', ${i})" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 transition-all"><i class="fas fa-trash-alt"></i></button>
                        <label class="input-label text-slate-900 font-black">Misi√≥n</label><input type="text" value="${t.task}" onchange="state.config.template['${state.dayType}'][${i}].task=this.value; saveLocal();" class="styled-input !bg-white !text-slate-900 mb-4 font-bold">
                        <div class="flex gap-4"><div class="flex-1 text-center"><label class="input-label text-slate-900 font-black">Inicio (AM/PM)</label><input type="text" value="${t.start}" onchange="state.config.template['${state.dayType}'][${i}].start=this.value; saveLocal();" class="styled-input !bg-white !text-slate-900"></div>
                        <div class="flex-1 text-center"><label class="input-label text-slate-900 font-black">Fin (AM/PM)</label><input type="text" value="${t.end}" onchange="state.config.template['${state.dayType}'][${i}].end=this.value; saveLocal();" class="styled-input !bg-white !text-slate-900"></div></div></div>`;
                });
                c.innerHTML += `<button onclick="addTask()" class="w-full bg-indigo-50 text-indigo-600 py-4 rounded-3xl border-2 border-dashed border-indigo-100 font-black uppercase text-[10px] mt-4"><i class="fas fa-plus mr-2"></i> A√±adir Actividad</button>`;
            } else if(state.tab === 'medico') {
                state.config.treatments.forEach((tr, i) => {
                    c.innerHTML += `<div class="config-block shadow-sm !bg-slate-50 border-slate-200">
                        <button onclick="delMed(${i})" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 transition-all"><i class="fas fa-trash-alt"></i></button>
                        <label class="input-label text-slate-900 font-black">Tratamiento</label><input type="text" value="${tr.name}" onchange="state.config.treatments[${i}].name=this.value; saveLocal();" class="styled-input !bg-white !text-slate-900 mb-4 font-bold">
                        <div class="flex gap-3 mb-4">
                            <div class="flex-1 text-center"><label class="input-label text-slate-900 font-black">Inicio</label><input type="date" value="${tr.start}" onchange="state.config.treatments[${i}].start=this.value; saveLocal();" class="styled-input !bg-white text-xs font-black"></div>
                            <div class="flex-1 text-center"><label class="input-label text-slate-900 font-black">Cant.</label><input type="number" value="${tr.duration}" onchange="state.config.treatments[${i}].duration=this.value; saveLocal();" class="styled-input !bg-white !text-slate-900"></div>
                            <div class="flex-1 text-center"><label class="input-label text-slate-900 font-black">Unidad</label><select onchange="state.config.treatments[${i}].unit=this.value; saveLocal();" class="styled-input !bg-white !text-slate-900 text-[10px] uppercase font-black">
                                <option value="dias" ${tr.unit==='dias'?'selected':''}>D√≠as</option><option value="meses" ${tr.unit==='meses'?'selected':''}>Meses</option>
                            </select></div>
                        </div>
                        <label class="input-label text-slate-900 font-black">Frecuencia (Horas)</label>
                        <input type="number" value="${tr.doseFreq}" onchange="state.config.treatments[${i}].doseFreq=this.value; saveLocal();" class="styled-input !bg-white !text-slate-900 font-black">
                    </div>`;
                });
                c.innerHTML += `<button onclick="addMed()" class="w-full bg-red-50 text-red-600 py-4 rounded-3xl border-2 border-dashed border-red-100 font-black uppercase text-[10px] mt-4"><i class="fas fa-plus mr-2"></i> A√±adir Medicina</button>`;
            } else if(state.tab === 'filtro') {
                c.innerHTML = `<div class="p-6 bg-slate-50 rounded-[2.5rem] space-y-6">
                    <p class="text-[11px] font-black text-slate-500 uppercase text-center border-b pb-4">Categor√≠as a ocultar en Vacaciones:</p>
                    <div class="space-y-3">
                        ${['academia', 'musica', 'deporte', 'salud', 'ocio'].map(cat => `
                            <label class="flex items-center justify-between p-4 bg-white rounded-2xl border border-slate-200 cursor-pointer active:scale-95 transition-all text-slate-900">
                                <span class="text-xs font-black uppercase text-slate-700">${cat}</span>
                                <input type="checkbox" class="w-6 h-6 rounded accent-indigo-600" 
                                    ${state.config.vacationHidden.includes(cat) ? 'checked' : ''} 
                                    onchange="toggleVacationCategory('${cat}')">
                            </label>
                        `).join('')}
                    </div>
                </div>`;
            } else if(state.tab === 'data') {
                c.innerHTML = `<div class="p-8 bg-indigo-50 rounded-[3rem] space-y-6 text-center border border-indigo-100 shadow-inner">
                    <button onclick="exportJSON()" class="w-full bg-white text-indigo-600 p-5 rounded-2xl font-black text-xs uppercase shadow-md active:scale-95 transition-all"><i class="fas fa-download mr-3"></i> Descargar .JSON</button>
                    <div class="pt-6 border-t border-indigo-100">
                        <p class="text-[10px] font-black uppercase text-indigo-400 mb-4 text-center">Importar Backup:</p>
                        <input type="file" id="json-import" class="hidden" accept=".json" onchange="importJSON(event)">
                        <button onclick="document.getElementById('json-import').click()" class="w-full bg-slate-950 text-white p-5 rounded-2xl font-black text-xs uppercase shadow-xl active:scale-95 transition-all"><i class="fas fa-upload mr-3"></i> Cargar archivo</button>
                    </div>
                </div>`;
            }
        }

        // --- HELPERS ---
        window.toggleVacationCategory = (cat) => { const index = state.config.vacationHidden.indexOf(cat); if (index > -1) state.config.vacationHidden.splice(index, 1); else state.config.vacationHidden.push(cat); saveLocal(); };
        window.addTask = () => { state.config.template[state.dayType].push({ id: 'task_'+Date.now(), start: '08:00 AM', end: '09:00 AM', task: 'Nueva Misi√≥n', type: 'musica' }); renderTab(); };
        window.addMed = () => { state.config.treatments.push({ id: 'med_'+Date.now(), name: 'Medicina', start: state.selectedDate, duration: 7, unit: 'dias', doseFreq: '8' }); renderTab(); };
        window.delTask = (d, i) => { state.config.template[d].splice(i, 1); renderTab(); };
        window.delMed = (i) => { state.config.treatments.splice(i, 1); renderTab(); };
        window.updateNameDisplays = () => { const n = state.config.userName || 'Usuario'; document.querySelectorAll('.user-name-display, .display-name').forEach(el => el.innerText = n.toUpperCase()); };
        window.updateLive = () => { const n = new Date(); document.getElementById('live-clock').innerText = n.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: true }); document.getElementById('live-date').innerText = n.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' }); render(); };
        window.parseTime = (t, iso) => { const [time, mod] = t.split(' '); let [h, m] = time.split(':').map(Number); if(mod === 'PM' && h < 12) h += 12; if(mod === 'AM' && h === 12) h = 0; const d = new Date(iso + 'T00:00:00'); d.setHours(h, m, 0, 0); return d; };
        const formatTo12 = (d) => { let h = d.getHours(), m = d.getMinutes(), mod = h >= 12 ? 'PM' : 'AM'; h = h % 12 || 12; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')} ${mod}`; };
        function renderStats(s, count, total) { const grid = document.getElementById('stats-grid'); grid.innerHTML = ''; [{id:'musica',l:'M√∫sica',c:'bg-purple-500'},{id:'deporte',l:'Deporte',c:'bg-orange-500'},{id:'academia',l:'Estudios',c:'bg-indigo-500'},{id:'salud',l:'Salud',c:'bg-red-500'}].forEach(type => { const p = s.total[type.id] > 0 ? Math.round((s[type.id] / s.total[type.id]) * 100) : 0; grid.innerHTML += `<div><div class="flex justify-between mb-2 font-black text-[9px] uppercase opacity-70 text-[var(--text-main)]"><span>${type.l}</span><span>${p}%</span></div><div class="h-1.5 bg-slate-500/10 rounded-full overflow-hidden shadow-inner"><div class="${type.c} h-full transition-all duration-1000" style="width: ${p}%"></div></div></div>`; }); document.getElementById('total-perc').innerText = `${Math.round((count/total)*100 || 0)}%`; }
        
        function initCalendar() { 
            const strip = document.getElementById('calendar-strip'); strip.innerHTML = ''; 
            for (let i = 0; i <= 14; i++) { 
                const d = new Date(); d.setDate(d.getDate() + i); const iso = new Intl.DateTimeFormat('sv-SE').format(d); 
                const day = document.createElement('div'); day.className = `calendar-day ${iso === state.selectedDate ? 'selected' : 'text-white opacity-40 hover:opacity-100'}`; 
                day.onclick = () => { state.selectedDate = iso; initCalendar(); render(); }; 
                day.innerHTML = `<span class="text-[8px] font-black uppercase tracking-tighter">${new Intl.DateTimeFormat('es-ES', { weekday: 'short' }).format(d)}</span><span class="text-xl font-black mt-1 leading-none">${d.getDate()}</span>`; 
                strip.appendChild(day); 
            } 
            strip.scrollLeft = 0;
        }

        window.exportJSON = () => { const b = new Blob([JSON.stringify(state.config, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `kairos_backup.json`; a.click(); };
        window.importJSON = (e) => { const r = new FileReader(); r.onload = (ev) => { try { state.config = JSON.parse(ev.target.result); updateNameDisplays(); applyTheme(); alert("¬°Importado!"); renderTab(); } catch(e) { alert("Archivo Inv√°lido."); } }; r.readAsText(e.target.files[0]); };
        window.toggleTask = (id) => { if(!state.history[state.selectedDate]) state.history[state.selectedDate] = {}; state.history[state.selectedDate][id] = !state.history[state.selectedDate][id]; saveLocal(); render(); };
        window.openTech = () => document.getElementById('tech-modal').classList.remove('hidden');
        window.closeTech = () => document.getElementById('tech-modal').classList.add('hidden');
        window.toggleVacation = () => { state.isVacation = !state.isVacation; const b = document.getElementById('vacation-btn'); b.className = state.isVacation ? "px-5 py-2.5 bg-indigo-600 text-white text-[10px] font-black rounded-full uppercase" : "px-5 py-2.5 bg-[var(--bg-card)] text-[var(--text-muted)] text-[10px] font-black rounded-full uppercase border border-[var(--border)]"; render(); };

        function renderTech() {
            const t = [
                { 
                    i: 'üçÖ', 
                    n: 'T√©cnica Pomodoro (25/5)', 
                    p: 'Es el arma secreta de la concentraci√≥n. Divide tu estudio en bloques de 25 min de foco puro y 5 de descanso total.',
                    e: 'Ejemplo: En tu misi√≥n de "Tareas Colegio" (11:15 AM), pon un cron√≥metro de 25 min. Cuando suene, ¬°al√©jate del escritorio! Bebe agua o est√≠rate. Esto evita que tu mente se "bloquee" antes de entrar al colegio a las 12:30 PM.'
                },
                { 
                    i: 'üëÅÔ∏è', 
                    n: 'Escudo Visual 20-20-20', 
                    p: 'Fundamental para curar tu conjuntivitis at√≥pica. Evita que el nervio √≥ptico se tense y la l√°grima se seque.',
                    e: 'Ejemplo: Mientras haces "Duolingo" o usas las "Apps de M√∫sica" (09:45 PM), cada 20 min mira por la ventana a un √°rbol o edificio lejano (6 metros) por 20 segundos. Esto relaja tus ojos para que la Fluorometolona final trabaje mejor mientras duermes.'
                },
                { 
                    i: 'üéª', n: 'Recuerdo Activo (Active Recall)', 
                    p: 'No leas la partitura o el cuaderno mil veces. Forzar al cerebro a recordar sin mirar crea cables de memoria 10 veces m√°s fuertes.',
                    e: 'Ejemplo: En tu misi√≥n de "Instrumento" (07:00 AM), intenta tocar un pasaje dif√≠cil cerrando los ojos. Si fallas, mira la nota solo un segundo y repite de memoria. Lo mismo con el colegio: al salir, intenta recordar las 3 ideas m√°s importantes del d√≠a sin mirar tus notas.'
                },
                { 
                    i: 'üß©', n: 'Pr√°ctica Intercalada', 
                    p: 'El cerebro se aburre con la repetici√≥n mec√°nica. Alternar temas diferentes mantiene la plasticidad neuronal al m√°ximo.',
                    e: 'Ejemplo: No pases toda la hora de "Apps M√∫sica" (08:45 PM) solo en una app. Haz 10 min de Formar O√≠do, 10 min de Ritmo y 10 min de Bloque Arm√≥nico. El cambio constante obliga a tu cerebro a "despertar" en cada transici√≥n.'
                },
                { 
                    i: 'üéì', n: 'M√©todo Feynman', 
                    p: 'La prueba definitiva de que sabes algo. Si puedes explicarlo simple, es porque realmente lo dominas.',
                    e: 'Ejemplo: Durante la "Cena" (09:30 PM), cu√©ntale a tus padres lo que aprendiste en "Colegio" o en tu pr√°ctica de "Instrumento" como si se lo explicaras a un ni√±o de 5 a√±os. Si logras que sea sencillo, ¬°eres un experto!'
                }
            ];
            document.getElementById('tech-content').innerHTML = t.map(x => `
                <div class="flex gap-6 items-start border-b border-slate-100 pb-12">
                    <span class="text-6xl leading-none shadow-sm">${x.i}</span>
                    <div class="space-y-4">
                        <h4 class="text-2xl font-black text-indigo-950 uppercase mb-3 leading-tight tracking-tight">${x.n}</h4>
                        <p class="text-lg text-slate-600 font-semibold leading-relaxed">${x.p}</p>
                        <div class="bg-indigo-50 p-6 rounded-[2rem] border-l-8 border-indigo-500 italic">
                            <p class="text-[14px] text-indigo-900 font-bold leading-relaxed underline mb-2">Aplicaci√≥n en tu Horario:</p>
                            <p class="text-[13px] text-indigo-800 font-medium">${x.e}</p>
                        </div>
                    </div>
                </div>`).join('');
        }

        window.onload = init;
    </script>
</body>
</html>
